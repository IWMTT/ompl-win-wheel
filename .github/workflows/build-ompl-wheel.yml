name: Build OMPL Windows wheel

on:
  workflow_dispatch:

jobs:
  build-wheel:
    runs-on: windows-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python build deps (numpy / pygccxml / pyplusplus / build)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy pygccxml pyplusplus build

      - name: Create tools directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path C:\tools -Force | Out-Null

      - name: Clone vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\tools\vcpkg

      - name: Bootstrap vcpkg
        shell: pwsh
        working-directory: C:\tools\vcpkg
        run: |
          .\bootstrap-vcpkg.bat

      - name: Install C++ deps via vcpkg (Boost/Eigen/yaml-cpp)
        shell: pwsh
        working-directory: C:\tools\vcpkg
        run: |
          .\vcpkg.exe install `
            boost:x64-windows `
            boost-python:x64-windows `
            eigen3:x64-windows `
            yaml-cpp:x64-windows

      - name: Install castxml (for bindings generation)
        shell: pwsh
        run: |
          choco install -y castxml

      - name: Create src directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path C:\src -Force | Out-Null

      - name: Clone OMPL
        shell: pwsh
        run: |
          git clone https://github.com/ompl/ompl.git C:\src\ompl

      - name: Init OMPL submodules
        shell: pwsh
        working-directory: C:\src\ompl
        run: |
          git submodule update --init --recursive

      - name: Configure OMPL with CMake (Python bindings ON, VAMP OFF)
        shell: pwsh
        run: |
          cmake -S C:\src\ompl -B C:\src\ompl\build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DOMPL_BUILD_PYBINDINGS=ON `
            -DOMPL_BUILD_VAMP=OFF `
            -DPYTHON_EXECUTABLE="$env:pythonLocation\python.exe" `
            -DCMAKE_TOOLCHAIN_FILE=C:\tools\vcpkg\scripts\buildsystems\vcpkg.cmake

      - name: Build OMPL + Python bindings
        shell: pwsh
        run: |
          cmake --build C:\src\ompl\build --config Release --target update_bindings
          cmake --build C:\src\ompl\build --config Release

      - name: Prepare wheel source tree
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path C:\wheel\src -Force | Out-Null
          Copy-Item -Recurse -Force C:\src\ompl\build\Release\py-bindings\ompl C:\wheel\src\ompl

          python - << 'PY'
          from pathlib import Path

          root = Path(r"C:\wheel")
          root.mkdir(parents=True, exist_ok=True)

          (root / "pyproject.toml").write_text(
              "[build-system]\n"
              'requires = ["setuptools", "wheel"]\n'
              'build-backend = "setuptools.build_meta"\n',
              encoding="utf-8",
          )

          (root / "setup.cfg").write_text(
              "[metadata]\n"
              "name = ompl\n"
              "version = 1.6.0\n"
              "description = OMPL Python bindings (Windows build)\n"
              "author = OMPL / local build\n"
              "license = BSD-3-Clause\n"
              "\n"
              "[options]\n"
              "package_dir =\n"
              "    =src\n"
              "packages = find:\n"
              "\n"
              "[options.packages.find]\n"
              "where = src\n",
              encoding="utf-8",
          )
          PY

      - name: Build wheel
        shell: pwsh
        working-directory: C:\wheel
        run: |
          python -m build

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ompl-windows-wheel
          path: C:\wheel\dist\*.whl
