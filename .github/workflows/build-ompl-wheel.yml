name: Build OMPL Windows wheel

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-wheel:
    runs-on: windows-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python build deps (pygccxml, pyplusplus, build)
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy pygccxml pyplusplus build

      - name: Clone vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\tools\vcpkg

      - name: Bootstrap vcpkg
        working-directory: C:\tools\vcpkg
        run: |
          .\bootstrap-vcpkg.bat

      - name: Install C++ deps via vcpkg (Boost/Eigen/yaml-cpp)
        working-directory: C:\tools\vcpkg
        run: |
          .\vcpkg.exe install `
            boost:x64-windows `
            boost-python:x64-windows `
            eigen3:x64-windows `
            yaml-cpp:x64-windows

      - name: Clone OMPL
        run: |
          git clone https://github.com/ompl/ompl.git C:\src\ompl

      - name: Init OMPL submodules
        working-directory: C:\src\ompl
        run: |
          git submodule update --init --recursive

      - name: Configure OMPL with CMake (Python bindings ON)
        run: |
          cmake -S C:\src\ompl -B C:\src\ompl\build `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DOMPL_BUILD_PYBINDINGS=ON `
            -DPYTHON_EXECUTABLE=%PythonLocation%\python.exe `
            -DCMAKE_TOOLCHAIN_FILE=C:\tools\vcpkg\scripts\buildsystems\vcpkg.cmake

      - name: Build OMPL + Python bindings
        run: |
          cmake --build C:\src\ompl\build --config Release --target update_bindings
          cmake --build C:\src\ompl\build --config Release

      - name: Prepare wheel source tree
        run: |
          mkdir C:\wheel
          mkdir C:\wheel\src
          xcopy /E /I C:\src\ompl\build\Release\py-bindings\ompl C:\wheel\src\ompl

          echo [build-system] >  C:\wheel\pyproject.toml
          echo requires = ['setuptools', 'wheel'] >> C:\wheel\pyproject.toml
          echo build-backend = 'setuptools.build_meta' >> C:\wheel\pyproject.toml

          echo [metadata]                           >  C:\wheel\setup.cfg
          echo name = ompl                          >> C:\wheel\setup.cfg
          echo version = 1.6.0                      >> C:\wheel\setup.cfg
          echo description = OMPL Python bindings (Windows build) >> C:\wheel\setup.cfg
          echo author = OMPL / local build          >> C:\wheel\setup.cfg
          echo license = BSD-3-Clause               >> C:\wheel\setup.cfg
          echo.                                     >> C:\wheel\setup.cfg
          echo [options]                            >> C:\wheel\setup.cfg
          echo package_dir =                        >> C:\wheel\setup.cfg
          echo `    =src                            >> C:\wheel\setup.cfg
          echo packages = find:                     >> C:\wheel\setup.cfg
          echo.                                     >> C:\wheel\setup.cfg
          echo [options.packages.find]              >> C:\wheel\setup.cfg
          echo where = src                          >> C:\wheel\setup.cfg

      - name: Build wheel
        working-directory: C:\wheel
        run: |
          python -m build

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ompl-windows-wheel
          path: C:\wheel\dist\*.whl
